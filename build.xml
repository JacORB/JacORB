<?xml version="1.0"?>

<project name="main" default="all" basedir=".">

  <!-- ==================================================== -->
  <!--            JacORB build file                         -->
  <!-- $Id$ -->
  <!-- ==================================================== -->

   <target name="init" depends="javatest">
	<property name="Name" value="main"/>
	<property name="name" value="main"/>
	<property name="dirs.base" value="${basedir}"/>
	<property name="classdir" value="${dirs.base}/classes"/>
	<property name="classpath" 
                  value="${java.class.path}:${dirs.base}/classes"/>
	<property name="src" value="${dirs.base}/src"/>
	<property name="lib" value="${dirs.base}/lib"/>
	<mkdir dir="${classdir}"/>
	<mkdir dir="${lib}"/>
	<available classname="java.util.Collection" property="java2.present"/>
	<filter token="path" value="basedir"/>
   </target>

   <!-- check for Java 2 -->
   <target name="javatest">
	<available classname="java.lang.ref.WeakReference"
	property="java2" />	
   </target>

   <!-- top-level targets  -->

   <target name="all" depends="init,compiler,omg_idl,jacorb,libs" />

   <!--               -->
   <!-- IDL compiler  -->
   <!--               -->

   <target name="compiler" depends="init,java_cup,idlsrc, idllib, idlcmd" />

   <target name="idlcmd" depends="idlcmd1,idlcmd2"/>

   <!-- generate idl.bat for JDK 1.1 -->

   <target name="idlcmd1" unless="java2">
        <delete file="bin/idl" />
        <delete file="bin/idl.bat" />
        <copy file="bin/idltemplate" tofile="bin/idl" />   
        <copy file="bin/idltemplate.bat" tofile="bin/idl.bat" />
        <replace file="bin/idl" token="@@@" 
                 value="${java.home}\lib\classes.zip:${basedir}"/>
        <replace file="bin/idl.bat" token="@@@" 
                 value="${java.home}\lib\classes.zip;${basedir}"/>
        <chmod file="bin/idl" perm="ugo+rx"/>
   </target>  

   <!-- generate idl.bat for JDK 1.2 or 1.3 -->

   <target name="idlcmd2" if="java2">
        <delete file="bin/idl" />
        <delete file="bin/idl.bat" />
        <copy file="bin/idltemplate" tofile="bin/idl" />   
        <copy file="bin/idltemplate.bat" tofile="bin/idl.bat" />
        <replace file="bin/idl" token="@@@" value="${basedir}"/>
        <replace file="bin/idl.bat" token="@@@" value="${basedir}"/>
        <chmod file="bin/idl" perm="ugo+rx"/>
   </target> 

   <!-- package idl.jar -->

   <target name="idllib" depends="java_cup,idlsrc" >
        <jar jarfile="${lib}/idl.jar" 
             basedir="${classdir}"
	         includes="org/jacorb/idl/**,java_cup/**"
	     />
   </target>  

    <target name="idlsrc">
	<ant antfile="${src}/org/jacorb/idl/build.xml" dir="${basedir}" />
    </target>

    <target name="java_cup">
	<ant antfile="${src}/java_cup/build.xml" dir="${basedir}"/>
   </target>

   <!-- ==================================================== -->
   <!--                   OMG IDL files                      -->
   <!-- ==================================================== -->

   <target name="omg_idl" depends="init">
        <ant antfile="${basedir}/idl/build.xml" dir="${basedir}"/>
   </target>



   <!-- ==================================================== -->
   <!--                   JacORB implementation              -->
   <!-- ==================================================== -->

   <target name="jacorb" depends="init">
        <ant antfile="${src}/org/jacorb/build.xml" dir="${basedir}"/>
   </target>

   <!-- ==================================================== -->
   <!--                  Libraries                           -->
   <!-- ==================================================== -->


   <target name="libs" depends="init,jar,jaco"/>

   <target name="jar" depends="init">
      <delete file="${lib}/jacorb.jar"/>
       <jar jarfile="${lib}/jacorb.jar" 
	    basedir="${classdir}"
	    includes="jacorb/**,org/omg/**, HTTPClient/**"
	    excludes="jacorb/idl/**"
	    />	    
   </target>

   <target name="jaco" depends="init, jaco1, jaco2"/>

   <target name="jaco1" unless="java2">
            <delete file="bin/jaco" />
            <delete file="bin/jaco.bat" />
            <copy file="bin/jacotemplate1" tofile="bin/jaco" />
            <copy file="bin/jacotemplate1.bat" tofile="bin/jaco.bat" />
           <replace file="bin/jaco.bat" token="@@@" value="${basedir}\lib\jacorb.jar;${java.home}\lib\classes.zip"/>
           <replace file="bin/jaco" token="@@@" value="${basedir}/lib/jacorb.jar:${java.home}\lib\classes.zip" />
           <chmod file="bin/jaco" perm="ugo+rx"/>
   </target> 
 
   <target name="jaco2" if="java2">
            <delete file="bin/jaco" />
            <delete file="bin/jaco.bat" />
            <copy file="bin/jacotemplate" tofile="bin/jaco" />
            <copy file="bin/jacotemplate.bat" tofile="bin/jaco.bat" />
           <replace file="bin/jaco.bat" token="@@@" value="${basedir}\lib\jacorb.jar;${java.home}\lib\rt.jar"/>
           <replace file="bin/jaco" token="@@@"
            value="${basedir}/lib/jacorb.jar:${java.home}/lib/rt.jar" />
           <chmod file="bin/jaco" perm="ugo+rx"/>
   </target> 

   <!-- ==================================================== -->
   <!--                   clean up                           -->
   <!-- ==================================================== -->


   <target name="clean" depends="init">
      <delete>
           <fileset dir="${classdir}" includes="**"/>  
      </delete>
      <delete>
           <fileset dir="${src}/generated" includes="**"/>  
      </delete>
   </target>

   <!-- ==================================================== -->
   <!--                  API documentation                   -->
   <!-- ==================================================== -->


   <target name="doc" depends="init">
           <javadoc destdir="${basedir}/doc/api"
                    packagenames="jacorb.*">
                    <sourcepath> 
                                 <pathelement path="${src}" />
                                 <pathelement path="${src}/generated" />
                    </sourcepath> 
           </javadoc>
           <javadoc destdir="${basedir}/doc/api"
                    packagenames="org.omg.*">
                    <sourcepath> 
                                 <pathelement path="${src}" />
                                 <pathelement path="${src}/generated" />
                    </sourcepath> 
           </javadoc>
   </target>

</project>

