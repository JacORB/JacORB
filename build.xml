<?xml version="1.0"?>

<project name="main" default="all" basedir=".">

   <!-- ==================================================== -->
   <!--            JacORB build file                         -->
   <!-- $Id$ -->
   <!-- ==================================================== -->

   <target name="init">
   <property name="Name" value="main"/>
   <property name="name" value="main"/>
   <property name="dirs.base" value="${basedir}"/>
   <property name="classdir" value="${dirs.base}/classes"/>
   <property name="classpath" value="${dirs.base}/classes:${java.class.path}"/>
   <property name="src" value="${dirs.base}/src"/>
   <property name="lib" value="${dirs.base}/lib"/>
   <property name="debug" value="off"/>
   <mkdir dir="${classdir}"/>
   <mkdir dir="${lib}"/>
   <filter token="path" value="basedir"/>
   </target>

   <!-- top-level target -->
   <target name="all" depends="init,compiler,omg_idl,jacorb,libs"
      description="Build JacORB. Use -Ddebug=on to compile code with debug."/>


   <!-- ==================================================== -->
   <!--                   IDL compiler                       -->
   <!-- ==================================================== -->

   <target name="compiler" depends="init,java_cup,idlsrc,idllib,idlcmd"/>

   <target name="idlcmd">
        <copy overwrite="yes" file="bin/idltemplate" tofile="bin/idl" />
        <copy overwrite="yes" file="bin/idltemplate.bat" tofile="bin/idl.bat" />
        <replace file="bin/idl" token="@@@" value="${basedir}"/>
        <replace file="bin/idl.bat" token="@@@" value="${basedir}"/>
        <chmod file="bin/idl" perm="ugo+rx"/>
   </target>

   <!-- package idl.jar -->
   <target name="idllib" depends="java_cup,idlsrc" >
        <jar jarfile="${lib}/idl.jar"
             basedir="${classdir}"
             includes="org/jacorb/idl/**,java_cup/**"
       />
   </target>

   <target name="idlsrc">
      <ant antfile="${src}/org/jacorb/idl/build.xml" dir="${basedir}" />
   </target>

   <target name="java_cup">
      <ant antfile="${src}/java_cup/build.xml" dir="${basedir}"/>
   </target>


   <!-- ==================================================== -->
   <!--                   OMG IDL files                      -->
   <!-- ==================================================== -->

   <target name="omg_idl" depends="init">
        <ant antfile="${basedir}/idl/build.xml" dir="${basedir}"/>
   </target>


   <!-- ==================================================== -->
   <!--           HTTP client for HTTP Tunneling             -->
   <!-- ==================================================== -->


   <target name="http" depends="init">
       <ant antfile="${src}/HTTPClient/build.xml" dir="${basedir}"/>
   </target>


   <!-- ==================================================== -->
   <!--                   JacORB implementation              -->
   <!-- ==================================================== -->

   <target name="jacorb" depends="init">
        <ant antfile="${src}/org/jacorb/build.xml" dir="${basedir}"/>
   </target>


   <!-- ==================================================== -->
   <!--                  Libraries                           -->
   <!-- ==================================================== -->

   <target name="libs" depends="init,jar,jaco"/>

   <target name="jar" depends="init">
      <delete file="${lib}/jacorb.jar"/>
       <jar jarfile="${lib}/jacorb.jar"
      basedir="${classdir}"
      includes="org/jacorb/**,org/omg/**, HTTPClient/**"
      excludes="org/jacorb/idl/**"
      />
   </target>

   <target name="jaco" depends="init">
      <copy overwrite="yes" file="bin/jacotemplate" tofile="bin/jaco" />
      <copy overwrite="yes" file="bin/jacotemplate.bat" tofile="bin/jaco.bat" />
      <replace file="bin/jaco.bat" token="@@@" value="${basedir}\lib\jacorb.jar;${java.home}\lib\rt.jar"/>
      <replace file="bin/jaco" token="@@@JACORB_HOME@@@"
         value="${basedir}" />
      <replace file="bin/jaco" token="@@@JRE_HOME@@@"
         value="${java.home}" />
      <chmod file="bin/jaco" perm="ugo+rx"/>
   </target>

   <!-- This target creates a jar file that contains the -->
   <!-- core ORB components and (genrated) OMG classes + -->
   <!-- the Naming Service -->
   <target name="core_jacorb_jar" depends="init">
      <delete file="${lib}/core_jacorb.jar"/>
       <jar jarfile="${lib}/core_jacorb.jar"
      basedir="${classdir}"
      includes="org/jacorb/orb/**,org/jacorb/naming/*,org/jacorb/poa/**,org/jacorb/util/**,org/omg/CONV_FRAME/**,org/omg/CORBA/**,org/omg/CORBA_2_3/**,org/omg/CosNaming/**,org/omg/Dynamic/**,org/omg/DynamicAny/**,org/omg/GIOP/**,org/omg/IIOP/**,org/omg/IOP/**,org/omg/Portable*/**,org/omg/BiDirPolicy/**"
            excludes="org/jacorb/orb/domain/gui/*,org/jacorb/poa/gui/*,org/jacorb/util/CAD*,org/jacorb/util/tracing/*,org/jacorb/orb/connection/http/*"
      />
   </target>

   <!-- This target creates a jar file that contains the -->
   <!-- following JacORB services and utilities: -->
   <!-- ImR + GUI, IR + GUI, Domain GUI, POA GUI, Tracing, Proxy -->
   <target name="jacorb_services_jar" depends="init">
      <delete file="${lib}/jacorb_services.jar"/>
       <jar jarfile="${lib}/jacorb_services.jar"
      basedir="${classdir}"
      includes="org/jacorb/imr/**,org/jacorb/ir/**,org/jacorb/orb/domain/gui/*,org/jacorb/poa/gui/*,org/jacorb/util/CAD*,org/jacorb/util/tracing/*,org/jacorb/proxy/*"
      />
   </target>

   <!-- This target creates a jar file that contains the -->
   <!-- following OMG services: -->
   <!-- Concurrency, Events, Trading, Transaction, but not Naming -->
   <target name="omg_services_jar" depends="init">
      <delete file="${lib}/omg_services.jar"/>
       <jar jarfile="${lib}/omg_services.jar"
      basedir="${classdir}"
      includes="org/jacorb/concurrency/**,org/jacorb/events/**,org/jacorb/trading/**,org/jacorb/transaction/**,org/omg/Cos*/**"
            excludes="org/omg/CosNaming/**"
      />
   </target>

   <!-- This target creates a jar file that contains the -->
   <!-- HTTP tunneling classes -->
   <target name="http_tunneling_jar" depends="init">
      <delete file="${lib}/http_tunneling.jar"/>
       <jar jarfile="${lib}/http_tunneling.jar"
      basedir="${classdir}"
      includes="HTTPClient/**,org/jacorb/orb/connection/http/*"
      />
   </target>

   <!-- This target creates a jar file that contains the -->
   <!-- (genrated) OMG and JacORB security classes -->
   <target name="security_jar" depends="init">
      <delete file="${lib}/security.jar"/>
       <jar jarfile="${lib}/security.jar"
      basedir="${classdir}"
      includes="org/jacorb/security/**,org/omg/Security*/**,org/omg/SSLIOP/**,org/omg/TimeBase/**"
      />
   </target>


   <!-- ==================================================== -->
   <!--                   clean up                           -->
   <!-- ==================================================== -->

   <target name="clean" depends="init" description="Clean the checkout">
      <delete file="${basedir}/bin/idl"/>
      <delete file="${basedir}/bin/idl.bat"/>
      <delete file="${basedir}/bin/jaco"/>
      <delete file="${basedir}/bin/jaco.bat"/>
      <delete dir="${classdir}/demo"/>
      <delete dir="${classdir}/org"/>
      <delete dir="${classdir}/java_cup"/>
      <delete dir="${classdir}/HTTPClient"/>
      <delete dir="${src}/generated/CosEventChannelAdmin"/>
      <delete dir="${src}/generated/CosEventComm"/>
      <delete dir="${src}/generated/org"/>
      <delete dir="${src}/generated/CORBA"/>
      <ant antfile="build.xml" dir="${src}/org/jacorb" target="clean"/>
   </target>

   <target name="realclean" depends="clean" description="Clean the checkout including generated jars">
      <delete>
        <fileset dir="lib/" includes="*.jar"/>
      </delete >
   </target>


   <!-- ==================================================== -->
   <!--                  API documentation                   -->
   <!-- ==================================================== -->

   <target name="doc" depends="init" description="Create the Javadoc">
      <mkdir dir="${basedir}/doc/api"/>
      <javadoc destdir="${basedir}/doc/api"
               Splitindex="Yes"
               Use="Yes"
               maxmemory="256m"
               packagenames="org.jacorb.*,org.omg.*,HTTPClient,java_cup.*">
         <sourcepath>
            <pathelement path="${src}" />
            <pathelement path="${src}/generated" />
            <pathelement path="${src}/HTTPClient" />
            <pathelement path="${src}/java_cup" />
         </sourcepath>
      </javadoc>
   </target>
</project>
