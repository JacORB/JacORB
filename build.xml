<?xml version="1.0"?>

<!DOCTYPE project [ <!ENTITY common SYSTEM "file:./etc/common.xml"> ]>

<project name="main" default="all" basedir=".">

   <!-- ==================================================== -->
   <!--            JacORB build file                         -->
   <!-- $Id$ -->
   <!-- ==================================================== -->

   &common;

   <!-- top-level target -->
   <target name="all" depends="init,compiler,omg_idl,jacorb,libs"
      description="Build JacORB. Use -Ddebug=lines,vars,source to compile code with full debugging."/>


   <!-- ==================================================== -->
   <!--                   IDL compiler                       -->
   <!-- ==================================================== -->

   <target name="compiler" depends="init,idlsrc,idllib,idlcmd"/>

   <target name="idlcmd">
        <copy overwrite="yes" file="bin/idltemplate" tofile="bin/idl" />
        <copy overwrite="yes" file="bin/idltemplate.bat" tofile="bin/idl.bat" />
        <replace file="bin/idl" token="@@@" value="${basedir}"/>
        <replace file="bin/idl.bat" token="@@@" value="${basedir}"/>
        <chmod file="bin/idl" perm="ugo+rx"/>
   </target>

   <!-- package idl.jar -->
   <target name="idllib" depends="idlsrc" >
        <jar jarfile="${lib}/idl.jar"
             basedir="${classdir}"
             includes="org/jacorb/idl/**"
       />
   </target>

   <target name="idlsrc">
      <ant antfile="${src}/org/jacorb/idl/build.xml" dir="${basedir}" />
   </target>



   <!-- ==================================================== -->
   <!--                   OMG IDL files                      -->
   <!-- ==================================================== -->

   <target name="omg_idl" depends="init">
        <ant antfile="${basedir}/idl/build.xml" dir="${basedir}"/>
   </target>


   <!-- ==================================================== -->
   <!--           HTTP client for HTTP Tunneling             -->
   <!-- ==================================================== -->


   <target name="http" depends="init">
       <ant antfile="${src}/HTTPClient/build.xml" dir="${basedir}"/>
   </target>


   <!-- ==================================================== -->
   <!--                   JacORB implementation              -->
   <!-- ==================================================== -->

   <target name="jacorb" depends="init">
        <ant antfile="${src}/org/jacorb/build.xml" dir="${basedir}"/>
   </target>


   <!-- ==================================================== -->
   <!--                  Libraries                           -->
   <!-- ==================================================== -->

   <target name="libs" depends="init,jar,jaco"/>

   <target name="jar" depends="init">
      <delete file="${lib}/jacorb.jar"/>
       <jar jarfile="${lib}/jacorb.jar"
      basedir="${classdir}"
      includes="org/jacorb/**,org/omg/**, HTTPClient/**"
      excludes="org/jacorb/idl/**,org/jacorb/demo/**,org/jacorb/test/**"
      manifest="${basedir}/etc/jacorb_jar.manifest"
      index="true"
      />
   </target>

   <target name="jaco" depends="init">
      <!-- Use the java.endorsed.dirs mechanism to replace the SDK CORBA classes with those in jacorb.jar for SDK 1.4 -->

      <condition property="jaco.classpath" value="-Djava.endorsed.dirs=${JACORB_HOME}/lib -classpath ${JACORB_HOME}/lib/jacorb.jar:${CLASSPATH}">
         <equals arg1="${ant.java.version}" arg2="1.4"/>
      </condition>
      <condition property="jacobat.classpath" value="-Djava.endorsed.dirs=&quot;${basedir}\lib&quot; -classpath &quot;${basedir}\lib\jacorb.jar;%CLASSPATH%&quot;">
         <equals arg1="${ant.java.version}" arg2="1.4"/>
      </condition>
      <!-- ... else use -Xbootclaspath for older SDKs -->
      <property name="jaco.classpath" value="-Xbootclasspath/p:${JACORB_HOME}/lib/jacorb.jar:${JACORB_HOME}/lib/logkit-1.2.jar:${JACORB_HOME}/lib/avalon-framework-4.1.5.jar:${JACORB_HOME}/lib/concurrent-1.3.2.jar:${JACORB_HOME}/lib/antlr-2.7.2.jar:${JRE_HOME}/lib/rt.jar:${CLASSPATH}"/>
      <property name="jacobat.classpath" value="-Xbootclasspath/p:&quot;${basedir}\lib\jacorb.jar;${basedir}\lib\logkit-1.2.jar;${basedir}\lib\avalon-framework-4.1.5.jar;${basedir}\lib\concurrent-1.3.2.jar;${basedir}\lib\antlr-2.7.2.jar;${java.home}\lib\rt.jar;%CLASSPATH%&quot;"/>
      <copy overwrite="yes" file="bin/jacotemplate" tofile="bin/jaco" />
      <copy overwrite="yes" file="bin/jacotemplate.bat" tofile="bin/jaco.bat" />

      <replace file="bin/jaco.bat" token="@@@CLASSPATH@@@" value="${jacobat.classpath}"/>

      <replace file="bin/jaco" token="@@@JACORB_HOME@@@"
         value="${basedir}" />
      <replace file="bin/jaco" token="@@@JRE_HOME@@@"
         value="${java.home}" />
      <replace file="bin/jaco" token="@@@CLASSPATH@@@"
         value="${jaco.classpath}" />
      <chmod perm="ugo+rx">
         <fileset dir="bin">
            <include name="*" />
            <exclude name="*.bat" />
            <exclude name="*.exe" />
            <exclude name="*.conf" />
            <exclude name="*template*" />
         </fileset>
      </chmod>
   </target>

   <!-- This target creates a jar file that contains the -->
   <!-- core ORB components and (genrated) OMG classes + -->
   <!-- the Naming Service -->
   <target name="core_jacorb_jar" depends="init">
      <delete file="${lib}/core_jacorb.jar"/>
       <jar jarfile="${lib}/core_jacorb.jar"
      basedir="${classdir}"
      includes="org/jacorb/orb/**,org/jacorb/naming/*,org/jacorb/poa/**,org/jacorb/util/**,org/omg/CONV_FRAME/**,org/omg/CORBA/**,org/omg/CORBA_2_3/**,org/omg/CosNaming/**,org/omg/Dynamic/**,org/omg/DynamicAny/**,org/omg/GIOP/**,org/omg/IIOP/**,org/omg/IOP/**,org/omg/Portable*/**,org/omg/BiDirPolicy/**"
            excludes="org/jacorb/poa/gui/*,org/jacorb/util/CAD*,org/jacorb/util/tracing/*,org/jacorb/orb/connection/http/*"
      />
   </target>

   <!-- This target creates a jar file that contains the -->
   <!-- following JacORB services and utilities: -->
   <!-- ImR + GUI, IR + GUI, POA GUI, Tracing, Proxy -->
   <target name="jacorb_services_jar" depends="init">
      <delete file="${lib}/jacorb_services.jar"/>
       <jar jarfile="${lib}/jacorb_services.jar"
      basedir="${classdir}"
      includes="org/jacorb/imr/**,org/jacorb/ir/**,org/jacorb/poa/gui/*,org/jacorb/util/CAD*,org/jacorb/util/tracing/*,org/jacorb/proxy/*"
      />
   </target>

   <!-- This target creates a jar file that contains the -->
   <!-- following OMG services: -->
   <!-- Concurrency, Events, Trading, Transaction, but not Naming -->
   <target name="omg_services_jar" depends="init">
      <delete file="${lib}/omg_services.jar"/>
       <jar jarfile="${lib}/omg_services.jar"
      basedir="${classdir}"
      includes="org/jacorb/concurrency/**,org/jacorb/events/**,org/jacorb/trading/**,org/jacorb/transaction/**,org/omg/Cos*/**"
            excludes="org/omg/CosNaming/**"
      />
   </target>

   <!-- This target creates a jar file that contains the -->
   <!-- HTTP tunneling classes -->
   <target name="http_tunneling_jar" depends="init">
      <delete file="${lib}/http_tunneling.jar"/>
       <jar jarfile="${lib}/http_tunneling.jar"
      basedir="${classdir}"
      includes="HTTPClient/**,org/jacorb/orb/connection/http/*"
      />
   </target>

   <!-- This target creates a jar file that contains the -->
   <!-- (genrated) OMG and JacORB security classes -->
   <target name="security_jar" depends="init">
      <delete file="${lib}/security.jar"/>
       <jar jarfile="${lib}/security.jar"
      basedir="${classdir}"
      includes="org/jacorb/security/**,org/omg/Security*/**,org/omg/SSLIOP/**,org/omg/TimeBase/**"
      />
   </target>


   <!-- ==================================================== -->
   <!--                   clean up                           -->
   <!-- ==================================================== -->

   <target name="clean" depends="init" description="Clean the checkout">
      <delete file="${basedir}/bin/idl"/>
      <delete file="${basedir}/bin/idl.bat"/>
      <delete file="${basedir}/bin/jaco"/>
      <delete file="${basedir}/bin/jaco.bat"/>
      <delete dir="${classdir}/demo"/>
      <delete dir="${classdir}/org"/>
      <delete dir="${classdir}/HTTPClient"/>
      <delete dir="${src}/generated/org"/>
      <delete dir="${src}/generated/CORBA"/>
      <ant antfile="build.xml" dir="${src}/org/jacorb" target="clean"/>
   </target>

   <target name="realclean" depends="clean" description="Clean the checkout including generated jars">
      <delete failonerror="false" >
        <fileset dir="lib/" includes="jacorb.jar, idl.jar"/>
      </delete >
   </target>


   <!-- ==================================================== -->
   <!--                  API documentation                   -->
   <!-- ==================================================== -->

   <target name="doc" depends="init" description="Create the Javadoc">
      <mkdir dir="${basedir}/doc/api"/>
      <javadoc destdir="${basedir}/doc/api"
               additionalparam="-breakiterator"
               classpath="${lib}/jacorb.jar:${lib}/logkit-1.2.jar:${lib}/avalon-framework-4.1.5.jar:${classpath}"
               Splitindex="Yes"
               Use="Yes"
               maxmemory="256m"
               packagenames="org.jacorb.idl.*,org.jacorb.util.*,org.jacorb.orb.*,org.jacorb.imr.*,org.jacorb.ir.*,org.jacorb.poa.*,org.jacorb.events.*,org.jacorb.naming.*,org.jacorb.security.level2.*,org.jacorb.security.sas.*,org.omg.*">
<!--               packagenames="org.jacorb.*,org.omg.*,HTTPClient,java_cup.*"> -->
         <sourcepath>
            <pathelement path="${src}" />
            <pathelement path="${src}/generated" />
<!--            <pathelement path="${src}/HTTPClient" /> -->
<!--            <pathelement path="${src}/java_cup" /> -->
         </sourcepath>
      </javadoc>
   </target>
</project>
