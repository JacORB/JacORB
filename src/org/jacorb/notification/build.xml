<?xml version="1.0"?>

<!DOCTYPE project [
  <!ENTITY common SYSTEM "file:../../../../etc/common.xml">
]>

<project name="notification" default="all" basedir="../../../..">

<!-- ============================================================= -->
<!--              JacORB - NotificationService build file          -->
<!-- $Id$ -->
<!-- ============================================================= -->

  &common;

  <property name="notification.dir"
      value="${basedir}/src/org/jacorb/notification" />


  <target name="notification.init" depends="init, check-regexp">

    <!-- directory where the antlr grammar is located -->
    <property name="grammar.dir" value="${notification.dir}/grammar" />

    <!-- package to which the parser classes are generated -->
    <property name="antlr.target.package" value="org/jacorb/notification/parser" />

    <mkdir dir="${src}/generated/${antlr.target.package}" />

    <path id="antlr.classpath">
      <pathelement path="${basedir}/lib/antlr-2.7.2.jar" />
    </path>
  </target>


  <!-- This is the default target. It depends upon the private init       -->
  <!-- (which depends upon the common init). It calls the wrapper so that -->
  <!-- we can drop out if regexp is not available.                        -->
  <target name="all" depends="notification.init" description="Compile the notification">
     <antcall target="all-wrapper" inheritRefs="true"/>
  </target>


  <target name="all-fail" unless="regexp.available">
     <echo message="A Patternmatcher is necessary to build and use this "/>
     <echo message="NotificationService. Use JDK 1.4 or install gnu.regexp"/>
     <echo message="and make it available in the classpath."/>
     <echo message="gnu.regexp is available at http://www.cacas.org/java/gnu/regexp/"/>
  </target>


  <target name="all-wrapper" if="regexp.available" depends="all-fail">
     <antcall target="antlr" inheritRefs="true"/>
     <antcall target="server" inheritRefs="true"/>
  </target>


  <!-- ====== -->
  <!-- Parser -->
  <!-- ====== -->
  <target name="antlr" depends="antlr.depend, antlr.generate, antlr.compile" />


  <!-- check if parser needs to be generated -->
  <target name="antlr.depend">
    <uptodate property = "antlr.generate.notRequired"
      targetfile="${src}/generated/${antlr.target.package}/TCLParser.java" >
      <srcfiles dir="${grammar.dir}" includes="**/*.g" />
    </uptodate>
  </target>


  <!-- generate parser -->
  <target name="antlr.generate" unless="antlr.generate.notRequired" >
    <delete>
      <fileset dir="${src}/generated/${antlr.target.package}" includes="*.java, *.txt" />
    </delete>

    <copy file="${grammar.dir}/CommonTokenTypes.txt"
      todir="${src}/generated/${antlr.target.package}" />

    <java classname="antlr.Tool"  fork="yes" failonerror="yes"
          classpathref="antlr.classpath" >
      <arg line="-o ${src}/generated/${antlr.target.package} ${grammar.dir}/tcl-lexer.g" />
    </java>

    <java classname="antlr.Tool" fork="yes" failonerror="yes"
          classpathref="antlr.classpath" >
      <arg line="-o ${src}/generated/${antlr.target.package} ${grammar.dir}/comp-lexer.g" />
    </java>

    <echo message="*****************************************************************" />
    <echo message="* The Warnings 'Redefinition of token in tokens {...}: TOKEN'   *" />
    <echo message="* can be ignored. Unfortunately there is no way to disable them *" />
    <echo message="*****************************************************************" />

    <java classname="antlr.Tool" fork="yes" failonerror="yes" classpathref="antlr.classpath" >
      <arg line="-o ${src}/generated/${antlr.target.package} ${grammar.dir}/tcl.g" />
    </java>

    <!-- didn't like the optional antlr task -->
    <!--
    <antlr
    outputdirectory="${src}/generated/${antlr.target.package}"
    target="${grammar.dir}/tcl.g" />
    -->
  </target>


  <!-- compile generated parser and AST Classes -->
  <target name="antlr.compile">
    <antcall target="jacorb-javac">
      <param name="javac-src"
        value="${src}/generated" />
      <param name="javac-includes"
      value="org/jacorb/notification/parser/*.java" />
      <param name="javac-sourcepath"
        value="${src}" />
    </antcall>

    <antcall target="jacorb-javac">
      <param name="javac-includes" value="org/jacorb/notification/node/*.java" />
    </antcall>
  </target>


  <target name="server" depends="notification.compile.regexp.gnu, notification.compile.regexp.jdk">
    <antcall target="jacorb-javac">
      <param name="javac-includes"
             value="org/jacorb/notification/**/*.java" />
      <param name="javac-excludes"
             value="org/jacorb/notification/util/GNUPatternWrapper.java,
                    org/jacorb/notification/util/JDK14PatternWrapper.java,
                    org/jacorb/notification/Main.java" />
    </antcall>
    <javac srcdir="${src}"
           destdir="${classdir}" >
      <classpath>
        <pathelement location="${dirs.base}/classes"/>
        <pathelement location="${lib}/wrapper-3.0.3.jar"/>
      </classpath>
      <include name="org/jacorb/notification/Main.java"/>
    </javac>
  </target>


  <target name="notification.compile.regexp.gnu" if="available.regexp.gnu">
    <echo message="Compiling for gnu.regexp (pre JDK 1.4)" />
    <antcall target="jacorb-javac" >
      <param name="javac-includes"
             value="org/jacorb/notification/util/PatternWrapper.java,
                    org/jacorb/notification/util/GNUPatternWrapper.java" />
    </antcall>
  </target>


  <target name="notification.compile.regexp.jdk" if="available.regexp.jdk">
    <echo message="Compiling for java.util.regexp (JDK 1.4+)" />
    <antcall target="jacorb-javac">
      <param name="javac-includes"
             value="org/jacorb/notification/util/PatternWrapper.java,
                    org/jacorb/notification/util/JDK14PatternWrapper.java"/>
      </antcall>
  </target>


  <!-- clean -->
  <target name="clean" depends="init" description="Cleans the notification">
    <delete>
      <fileset dir="${src}/generated"
         includes="org/jacorb/notification/**/*.*" />
    </delete>
    <delete>
      <fileset dir="${classdir}"
         includes="org/jacorb/notification/**/*.*" />
    </delete>
  </target>


</project>
